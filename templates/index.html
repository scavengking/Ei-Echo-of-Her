<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ei- Echo of Her</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

    <style>
        /* Inter Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        /* Serif Font for Poetic Welcome (Example: Lora) */
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-image: linear-gradient(to bottom right,
                hsl(var(--gradient-start-h, 222), var(--gradient-start-s, 47%), var(--gradient-start-l, 11%)),
                hsl(var(--gradient-end-h, 260), var(--gradient-end-s, 65%), var(--gradient-end-l, 35%))
            );
            transition: background-image 0.5s linear; /* Smooth transition for dynamic background */
            overflow-x: hidden; /* Prevent horizontal scroll */
            display: flex; /* For centering content or sidebar layouts */
            color: #e5e7eb; /* Default light text color */
        }

        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -10; /* Behind all content */
            pointer-events: none; /* Allow clicks through */
        }

        /* Chat Bubble Styling */
        .chat-bubble {
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 70%; /* Max width of bubbles */
            word-wrap: break-word; /* Prevent long words from overflowing */
        }

        /* Custom Scrollbar for Chat Messages */
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-track { background: transparent; }
        #chat-messages::-webkit-scrollbar-thumb { background-color: rgba(139, 92, 246, 0.5); border-radius: 20px; }
        
        /* History Panel Styling */
        #history-panel {
            position: fixed; top: 0; left: 0; width: 280px; height: 100vh;
            background-color: rgba(23, 15, 35, 0.85); /* Darker, more opaque for readability */
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            padding: 1.5rem; border-right: 1px solid rgba(167, 139, 250, 0.3);
            box-shadow: 5px 0px 15px rgba(0,0,0,0.2);
            transform: translateX(-100%); /* Initially off-screen */
            transition: transform 0.4s ease-in-out;
            z-index: 30; /* Above persona selection if it's somehow active */
            display: flex; flex-direction: column; color: #e0e0ff;
        }
        #history-panel.open { transform: translateX(0); }

        #history-panel-toggle {
            position: fixed; top: 20px; left: 20px; z-index: 35; /* Above history panel when closed */
            background-color: rgba(124, 58, 237, 0.7); color: white; padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; cursor: pointer;
            transition: left 0.4s ease-in-out, background-color 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        #history-panel-toggle:hover { background-color: rgba(109, 40, 217, 0.9); }
        /* Adjust toggle button position when panel is open */
        #history-panel.open + #history-panel-toggle { left: 295px; /* width of panel + some margin */ }

        #history-list { list-style: none; padding: 0; margin-top: 1rem; overflow-y: auto; flex-grow: 1; }
        #history-list::-webkit-scrollbar { width: 5px; }
        #history-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        #history-list::-webkit-scrollbar-thumb { background-color: rgba(167, 139, 250, 0.4); border-radius: 10px; }

        .history-item {
            padding: 0.75rem 0.5rem; margin-bottom: 0.5rem; background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease;
            border-left: 3px solid transparent; /* For active state indication */
        }
        .history-item:hover { background-color: rgba(167, 139, 250, 0.2); border-left-color: #A78BFA; }
        .history-item.active-session { background-color: rgba(167, 139, 250, 0.3); border-left-color: #A78BFA; font-weight: 600; }
        .history-item-preview { font-size: 0.8rem; color: #c0b0e0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; margin-bottom: 0.25rem; }
        .history-item-timestamp { font-size: 0.7rem; color: #a090c0; display: block; }
        #new-chat-button-container { padding-top: 1rem; border-top: 1px solid rgba(167, 139, 250, 0.2); }

        /* Main Content Area - Adjusts for History Panel */
        #main-content-area {
            flex-grow: 1; display: flex; flex-direction: column; height: 100vh;
            transition: margin-left 0.4s ease-in-out;
            position: relative; /* For z-indexing of welcome message */
        }
        #history-panel.open ~ #main-content-area { margin-left: 280px; }

        /* Empty Session Placeholder */
        #empty-session-placeholder {
            font-size: 1.5rem;
            opacity: 0; /* Start hidden, fade in with JS */
            transition: opacity 0.5s ease-in-out;
        }
        #empty-session-placeholder.visible {
            opacity: 1;
        }

        /* Tooltip for Badges */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: max-content; /* Adjust width to content */
            max-width: 200px; /* Max width before wrapping */
            background-color: #37304a; /* Darker violet */
            color: #e0e0ff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px; /* More padding */
            position: absolute;
            z-index: 1;
            bottom: 135%; /* Position above the emoji */
            left: 50%;
            transform: translateX(-50%); /* Center tooltip */
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 0.75rem;
            white-space: normal; /* Allow text to wrap */
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        #earned-badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem; /* Space between badges */
            justify-content: flex-end; /* Align to the right */
            padding-top: 0.5rem;
        }
        .badge-item {
             cursor: default;
        }

        /* Ei's Avatar and Name Display */
        #ei-avatar-container {
            width: 100px;
            height: 150px;
            border-radius: 10px;
            overflow: hidden;
            background-color: rgba(124, 58, 237, 0.1);
            flex-shrink: 0;
        }
        #ei-avatar-model-viewer {
            width: 100%;
            height: 100%;
            --mv-interaction-prompt: none;
            background-color: transparent;
        }
        #ei-name-display {
            font-size: 1.125rem; 
            font-weight: 600;    
            color: #e0e0ff;      
            text-shadow: 0 0 8px rgba(220, 200, 255, 0.5);
        }

        /* Gamification Stats Box */
        #gamification-stats {
            width: 200px; 
            padding: 0.75rem;
            background-color: rgba(30, 41, 59, 0.6); 
            backdrop-filter: blur(4px);
            border-radius: 0.5rem; 
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); 
            color: #e5e7eb; 
            font-size: 0.75rem; 
        }

        #chat-messages {
            padding: 0.5rem; 
        }

        #chat-input-row {
            margin-top: auto; 
            padding-top: 0.5rem; 
        }

        #poetic-welcome {
            font-family: 'Lora', serif;
        }

        /* ADDED: Styling for code blocks generated by marked.js */
        .ei-bubble pre {
            background-color: rgba(10, 5, 20, 0.7); /* Dark background for code */
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            overflow-x: auto; /* Allow horizontal scrolling for long code lines */
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem; /* Slightly smaller font for code */
            border: 1px solid rgba(167, 139, 250, 0.2);
        }
        .ei-bubble code {
            font-family: 'Courier New', Courier, monospace;
        }
        .ei-bubble p code { /* For inline code `backticks` */
            background-color: rgba(10, 5, 20, 0.7);
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-size: 0.85em;
        }

        @media (max-width: 768px) { 
            #ei-avatar-container { width: 80px; height: 120px; }
            #gamification-stats { width: 160px; font-size: 0.65rem; }
            #chat-messages-wrapper.max-w-5xl { padding: 0.75rem; } 
            #history-panel { width: 240px; } 
            #history-panel.open + #history-panel-toggle { left: 255px; }
            #main-content-area { font-size: 0.9rem; }
            #message-input, #send-button, #persona-quick-select { height: 44px; padding: 0.6rem; }
        }
         @media (max-width: 480px) { 
            #ei-avatar-container { width: 60px; height: 90px; }
            #ei-name-display { font-size: 1rem; }
            #gamification-stats { width: 130px; font-size: 0.6rem; padding: 0.5rem; }
            #xp-level, #xp-current, #xp-next-level { font-size: 0.7rem; }
            #chat-top-row { margin-bottom: 0.25rem; }
            #chat-messages-wrapper { padding: 0.5rem; }
            #message-input, #send-button, #persona-quick-select { height: 40px; font-size:0.875rem; padding: 0.5rem; }
            #send-button svg { width: 1.25rem; height: 1.25rem; }
            #persona-quick-select { display: none; } 
            #chat-input-row { padding-left: 0; padding-right: 0; } 
         }
    </style>
</head>
<body class="text-gray-200">
    <canvas id="particle-canvas"></canvas>

    <div id="history-panel">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-violet-300">Chat Sessions</h3>
            <span id="username-display" class="text-sm text-gray-400"></span>
        </div>
        <div id="new-chat-button-container">
            <button id="new-chat-button" class="w-full p-2.5 bg-violet-600 hover:bg-violet-500 text-white rounded-lg shadow-md transition-colors duration-150 text-sm mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                New Chat
            </button>
        </div>
        <ul id="history-list">
        </ul>
        <div class="mt-auto pt-4 border-t border-violet-800/50 space-y-2">
            <a href="{{ url_for('subscription_page') }}" id="subscription-link" class="block w-full text-center p-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm">
                Go Pro
            </a>
            <a href="{{ url_for('logout') }}" class="block w-full text-center p-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm">
                Logout
            </a>
        </div>
    </div>
    
    <button id="history-panel-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
        </svg>
    </button>

    <div id="main-content-area" class="w-full">
        <div id="celestial-fragment-container" class="fixed top-4 left-4 md:top-8 md:left-8 w-16 h-16 md:w-24 md:h-24 z-0 opacity-70"> <svg id="celestial-fragment-svg" viewBox="0 0 100 100" style="overflow: visible;">
        <defs>
            <radialGradient id="fragmentCoreGradient" cx="50%" cy="50%" r="70%" fx="50%" fy="50%">
                <stop offset="0%" style="stop-color:rgba(230, 220, 255, 0.9);" /> 
                <stop offset="50%" style="stop-color:rgba(200, 180, 240, 0.7);" />
                <stop offset="100%" style="stop-color:rgba(150, 130, 200, 0.4);" /> 
            </radialGradient>

            <filter id="softGlowFilter" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                <feMerge>
                    <feMergeNode in="coloredBlur"/>
                    <feMergeNode in="SourceGraphic"/> 
                </feMerge>
            </filter>

            <radialGradient id="particleGradient" cx="50%" cy="50%" r="50%">
                <stop offset="0%" style="stop-color:rgba(240, 230, 255, 1);" />
                <stop offset="100%" style="stop-color:rgba(200, 190, 230, 0.5);" />
            </radialGradient>
        </defs>

        <g id="fragment-shape-group" filter="url(#softGlowFilter)">
            <path id="fragment-main" d="M50 15 L70 35 L65 65 L45 70 L30 50 L35 25 Z" fill="url(#fragmentCoreGradient)" />
            <path id="fragment-inner" d="M50 25 L60 40 L55 55 L45 50 L40 35 Z" fill="rgba(240, 230, 255, 0.3)" opacity="0.7"/>
        </g>

        <circle id="particle-1" cx="30" cy="30" r="1.5" fill="url(#particleGradient)" opacity="0"/>
        <circle id="particle-2" cx="70" cy="60" r="1" fill="url(#particleGradient)" opacity="0"/>
        <circle id="particle-3" cx="50" cy="80" r="1.2" fill="url(#particleGradient)" opacity="0"/>
    </svg>
</div>

        <div id="chat-ui-container" class="flex flex-col flex-grow h-full pt-1 pb-1 px-2 sm:px-4 md:pt-1 md:pb-2 md:px-6" style="position: relative; z-index: 1;">
            <div id="chat-top-row" class="flex justify-between items-start mb-2 md:mb-1">
                <div id="ei-presentation-area" class="flex items-center space-x-2 sm:space-x-3">
                    <div id="ei-avatar-container">
                        <model-viewer id="ei-avatar-model-viewer"
                                       src="" alt="Ei Avatar"
                                        touch-action="pan-y" disable-zoom
                                        interaction-prompt="none"
                                        shadow-intensity="1"
                                         camera-orbit="0deg 80deg 0.4m" 
                                          camera-target="0m 1.65m 0m" 
                                          field-of-view="5deg"        
                                          style="background-color: transparent;">
                                         </model-viewer>
                    </div>
                    <div id="ei-name-display" class="text-base sm:text-lg">Ei</div>
                </div>

                <div id="gamification-display-area" class="flex flex-col items-end">
                    <div id="gamification-stats">
                        <div class="flex justify-between items-center mb-1">
                            <span>Level:</span>
                            <span id="xp-level" class="font-semibold text-violet-300">1</span> 
                        </div>
                        <div class="w-full bg-slate-600 rounded-full h-2.5">
                            <div id="xp-bar" class="bg-violet-500 h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%;"></div>
                        </div>
                        <div class="text-center mt-1 text-xs">XP: <span id="xp-current">0</span> / <span id="xp-next-level">100</span></div>
                    </div>
                    <div id="earned-badges-container" class="mt-2">
                        </div>
                </div>
            </div>
            
            <div id="chat-messages-wrapper" 
                 class="flex-grow flex flex-col min-h-0 mb-1 sm:mb-2 max-w-5xl w-full mx-auto p-2 sm:p-4 rounded-lg shadow-xl"
                 style="background-color: rgba(23, 15, 40, 0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);"> 
                
                <div id="empty-session-placeholder" class="my-auto text-center text-gray-400 italic p-4 opacity-0 transition-opacity duration-500 flex-grow flex items-center justify-center"> 
                     <div>This session is empty. <br> Whisper your thoughts to Ei...</div>
                </div>
                <div id="chat-messages" class="flex-grow overflow-y-auto space-y-3 sm:space-y-4"> 
                     </div>
            </div>
    
            <div id="typing-indicator" class="h-6 mb-1 text-sm text-violet-300 italic text-center" style="display: none;"> 
                Ei is typing... 
            </div> 
            
            <div id="chat-input-row" class="flex items-end space-x-2 sm:space-x-3 max-w-5xl w-full mx-auto">
                <div id="persona-quick-change-container" class="hidden sm:block">
                    <select id="persona-quick-select" class="bg-slate-700/50 border border-violet-600/50 rounded-lg p-3 text-gray-100 text-sm focus:ring-violet-400 focus:border-transparent outline-none h-[48px]"> 
                        <option value="friendly">Friendly</option>
                        <option value="sage">Sage</option>
                        <option value="coding">Coding</option>
                        <option value="sarcastic">Sarcastic</option>
                        <option value="scifi">Sci-Fi</option>
                    </select>
                </div>
    
                <form id="chat-form" class="flex-grow flex items-center space-x-2 sm:space-x-3">
                    <input type="text" id="message-input" placeholder="Whisper your thoughts to Ei..." class="flex-grow p-3 bg-slate-700/50 border border-violet-600/50 rounded-lg focus:ring-2 focus:ring-violet-400 focus:border-transparent outline-none placeholder-violet-300/70 text-gray-100 shadow-md h-[48px]">
                    <button type="submit" id="send-button" class="p-3 bg-violet-600 hover:bg-violet-500 text-white rounded-lg shadow-md transition-colors duration-150 h-[48px] flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path d="M3.105 3.105a1.5 1.5 0 012.122-.001L19.43 11.192a.75.75 0 010 1.116L5.227 16.9a1.5 1.5 0 01-2.122-.001 1.5 1.5 0 01-.001-2.122L14.192 11.75 3.105 5.227a1.5 1.5 0 01-.001-2.122z" /></svg>
                    </button>
                </form>
            </div>
        </div>
    </div> 
    <script src="/static/js/main.js"></script>
</body>
</html>